@model IEnumerable<BestTyping.Models.CLASSROOM>
@{
    ViewBag.Title = "DashboardStudent";
    Layout = "~/Views/Shared/_LayoutUser.cshtml";
}

<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<link href="~/Theme/css/dashboardedu.css" rel="stylesheet" />
<link href="~/Theme/css/dashboardstu.css" rel="stylesheet" />
<header class="site-header-two">
    @Html.Partial("_PartialNavTop")
</header>
<div class="wrapper">
    @Html.Action("_PartialSideBarStu", "DashBoardStudent")
    <!-- Main Component -->
    <div class="main" style=" flex-direction: row;">
        <div class="content col-md-9 px-3 py-2">
            <div class="dashboard_wrapper">
                <button id="join-group">Tham gia nhóm học</button>
                <div class="dashboard_wrapper-content">
                    @foreach (var item in Model)
                    {
                        <div class="group__wrapper-item ">
                            <a class="link-group" href="">
                                <img class="group__wrapper-img" src="@item.AvatarClassRoom" />
                                <p class="group__wrapper-title">@item.ClassName </p>
                            </a>

                        </div>
                    }

                </div>
            </div>
        </div>
        <div class="col-md-3" style="padding-right:1rem;">
            <div class="event__wrapper">
                <p>Sự kiện sắp diễn ra</p>
                <div class="event__box">
                    <div class="event__box-item">
                        <span style="text-align:center">Không có sự kiện nào diễn ra</span>
                    </div>
                    @*<div class="event__box-item">
                        <div class="event__box-item-title">
                            <i class="fa fa-hand-o-right" aria-hidden="true"></i>
                            <span>Lớp lạ mà quen</span>
                        </div>
                        <div class="event__box-item-time">
                            <span>24/3/2024, </span>
                            <span> 2:00 AM » 2:15 AM</span>
                        </div>
                        <a href="">Đi đến hoạt động</a>
                    </div>*@
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modaljoinclass" class="modal">
    <div class="modal-content" style="width:30%">
        <div class="modal-header_title">
            <p id="title-class">Tham gia nhóm bằng mã</p>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <form class="form-control form-custom">
                <label>Bạn có thể tham gia lớp học bằng cách nhập mã.</label>
                <input id="codejoin" class="form-control" type="text" placeholder="Nhập mã" />

            </form>
        </div>
        <div class="modal-footer_custom">
            <button id="cancel" type="button">Hủy</button>
            <button id="join" type="button">Tham gia</button>
            <button id="confirm" type="button" style="display:none">Xác nhận</button>
        </div>
    </div>
</div>
<script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>
<script>
    var hub  = $.connection.requestJoinHub;
    toastr.options = {
        "closeButton": true, // Hiển thị nút đóng
        "debug": false,
        "newestOnTop": false,
        "progressBar": true, // Hiển thị thanh tiến trình
        "positionClass": "toast-top-right", // Vị trí
        "preventDuplicates": false,
        "onclick": null,
        "showDuration": "300",
        "hideDuration": "1000",
        "timeOut": "2000", // Thời gian tự đóng (ms)
        "extendedTimeOut": "1000",
        "showEasing": "swing",
        "hideEasing": "linear",
        "showMethod": "fadeIn",
        "hideMethod": "fadeOut"
    };
    var form = $(".form-custom");
    var $modal = $("#modaljoinclass");
    var $modalContent = $modal.find('.modal-content');

    $("#join-group").click(function () {
        $modal.show();
        $modalContent.css('animation', 'zoomIn 0.6s');
    })

    $("#join").click(function () {
        let code = $("#codejoin").val();

        if (code == "") {
            toastr.warning("Vui lòng nhập mã để tham gia!");
            return;
        }

        $.ajax({
            type: "post",
            url: "/DashBoardStudent/CheckCodeRoom",
            data: {
                data: code,
            },
            success: function (response) {
                if (response.code == 200) {
                    let idroom = response.id;
                    if (response.status == true && response.pass == 1) {
                        $("#join").prop("disabled", true).hide();
                        $("#confirm").show();
                        form.append(`<input id="pass-room" class="form-control" type="password" placeholder="Nhập mật khẩu" />`)
                        $("#confirm").click(function () {
                            let pass = $("#pass-room").val();

                            if (pass == "") {
                                toastr.warning("Vui lòng nhập mật khẩu để tham gia!");
                                return;
                            }

                            $.ajax({
                                type: "post",
                                url: "/DashBoardStudent/GiveRequestJoin",
                                data: {
                                    data: idroom
                                },
                                success: function (response) {
                                    if (response.code == 200) {
                                        toastr.success(response.msg);
                                        $.connection.hub.start().done(function () {
                                            hub.server.sendRequsetJoinList(idroom);
                                        });
                                    } else {
                                        toastr.warning(response.msg);
                                    }
                                }, error: function (err) {
                                    toastr.error("Có lỗi xảy ra khi gửi yêu cầu!");
                                }
                            })
                        })
                    }
                    else {

                        $.ajax({
                            type: "post",
                            url: "/DashBoardStudent/GiveRequestJoin",
                            data: {
                                data: idroom
                            },
                            success: function (response) {
                                if (response.code == 200) {
                                    toastr.success(response.msg);
                                    $(".close").trigger("click");

                                    $.connection.hub.start().done(function () {
                                        hub.server.sendRequsetJoinList(idroom);
                                    });

                                } else {
                                    toastr.warning(response.msg);
                                }
                            }, error: function (err) {
                                toastr.error("Có lỗi xảy ra khi gửi yêu cầu!");
                            }
                        })

                    }
                } else if (response.code == 400) {
                    toastr.warning(response.msg);
                } else {
                    toastr.warning(response.msg);
                }
            }, error: function (err) {
                toastr.error("Có lỗi xảy ra khi gửi yêu cầu!");
            }
        })
    })

    $(".close, #cancel").click(function () {
        $("body").removeClass("modal-open");
        $modalContent.css('animation', 'zoomOut 0.6s');
        setTimeout(function () {
            $modal.hide();
        }, 500);
    });
</script>